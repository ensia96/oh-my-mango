# 호출 도구 통합 및 시스템 프롬프트 수정

## 배경
- 현재 4개의 개별 호출 도구 존재: `call-*.ts`
- 망고(1계층)는 opencode 기본 Task 도구로 서브에이전트 호출
- call_mango는 서브에이전트 간 호출용 (관리→실행/어댑터)
- index.md TODO: "망고가 기본 호출 도구로만 에이전트들을 호출"

## 전제조건
- 현재 브랜치: main
- 워킹 디렉토리: 클린 (uncommitted 변경 없음)
- origin/main과 동기화됨
- 담당자: ensia96

## 작업

### 0. 계획 설정
**전제**: main 브랜치, 클린 상태

| 순서 | 담당 | 작업 | 검증 |
|------|------|------|------|
| 0-1 | 이슈 망고 | 이슈 생성: `task: 호출 도구 통합 및 시스템 프롬프트 수정` | 이슈 URL 확인 |
| 0-2 | PR 망고 | 브랜치 생성: `{이슈번호}/ensia96/2026-01-22` | 브랜치 체크아웃 확인 |
| 0-3 | 빌드 망고 | plan.md 프로젝트 루트에 생성 | 파일 존재 확인 |
| 0-4 | 빌드 망고 | 커밋: `docs: 계획 설정 - 호출 도구 통합 및 시스템 프롬프트 수정` | 커밋 성공 |
| 0-5 | PR 망고 | PR 생성: `[#29] ensia96 (2026-01-22)` | PR URL 확인 |

### 1. 권한 시스템 구현
**전제**: 0단계 완료, 작업 브랜치

| 순서 | 담당 | 작업 | 검증 |
|------|------|------|------|
| 1-1 | 빌드 망고 | `src/permissions.ts` 생성 | 파일 존재 |
| 1-2 | 빌드 망고 | CALL_PERMISSIONS 상수 정의 | - |
| 1-3 | 빌드 망고 | canCall(caller, target) 함수 구현 | - |
| 1-4 | 빌드 망고 | `npm run build` | 성공 |
| 1-5 | 빌드 망고 | 커밋: `feat: 권한 시스템 구현` | 커밋 성공 |

### 2. 통합 호출 도구 구현
**전제**: 1단계 완료

| 순서 | 담당 | 작업 | 검증 |
|------|------|------|------|
| 2-1 | 빌드 망고 | `src/tools/call-mango.ts` 생성 | 파일 존재 |
| 2-2 | 빌드 망고 | createCallMango(ctx, callerAgent) 팩토리 구현 | - |
| 2-3 | 빌드 망고 | agent enum 동적 생성 (callerAgent 기준) | - |
| 2-4 | 빌드 망고 | canCall 검증 → callAgent 호출 로직 | - |
| 2-5 | 빌드 망고 | `npm run build` | 성공 |
| 2-6 | 빌드 망고 | 커밋: `feat: 통합 호출 도구 구현` | 커밋 성공 |

### 3. index.ts 마이그레이션
**전제**: 2단계 완료

| 순서 | 담당 | 작업 | 검증 |
|------|------|------|------|
| 3-1 | 빌드 망고 | 기존 call_*_mango import 제거 | - |
| 3-2 | 빌드 망고 | createCallMango import 추가 | - |
| 3-3 | 빌드 망고 | 에이전트별 도구 세트 분리 | - |
| 3-4 | 빌드 망고 | `npm run build` | 성공 |
| 3-5 | 사용자 | 플러그인 리로드 → 로컬 테스트 | 동작 확인 |
| 3-6 | 빌드 망고 | 커밋: `refactor: 에이전트별 도구 세트 분리` | 커밋 성공 |

**에이전트별 도구 세트**:
- mango: remind_*, find_* (call_mango 없음)
- plan-mango, coach-mango: call_mango, remind_*, find_*
- 실행/어댑터 계층: remind_*, find_*

### 4. 기존 호출 도구 파일 삭제
**전제**: 3단계 완료

| 순서 | 담당 | 작업 | 검증 |
|------|------|------|------|
| 4-1 | 빌드 망고 | `src/tools/call-research-mango.ts` 삭제 | 파일 없음 |
| 4-2 | 빌드 망고 | `src/tools/call-build-mango.ts` 삭제 | 파일 없음 |
| 4-3 | 빌드 망고 | `src/tools/call-issue-mango.ts` 삭제 | 파일 없음 |
| 4-4 | 빌드 망고 | `src/tools/call-pr-mango.ts` 삭제 | 파일 없음 |
| 4-5 | 빌드 망고 | `npm run build` | 성공 |
| 4-6 | 빌드 망고 | 커밋: `refactor: 기존 개별 호출 도구 삭제` | 커밋 성공 |

### 5. 시스템 프롬프트 수정
**전제**: 4단계 완료

| 순서 | 담당 | 작업 | 검증 |
|------|------|------|------|
| 5-1 | 빌드 망고 | 망고 프롬프트: Task 도구로 서브에이전트 호출 명시 | - |
| 5-2 | 빌드 망고 | 관리 계층 프롬프트: call_mango 사용법, 호출 가능 대상 명시 | - |
| 5-3 | 빌드 망고 | `npm run build` | 성공 |
| 5-4 | 사용자 | 플러그인 리로드 → 로컬 테스트 | 동작 확인 |
| 5-5 | 빌드 망고 | 커밋: `feat: 시스템 프롬프트 수정` | 커밋 성공 |

### 6. 사용자 프롬프트 검토 및 다듬기
**전제**: 5단계 완료

| 순서 | 담당 | 작업 | 검증 |
|------|------|------|------|
| 6-1 | 사용자 | 시스템 프롬프트 직접 검토 및 수정 | - |
| 6-2 | 빌드 망고 | `npm run build` | 성공 |
| 6-3 | 빌드 망고 | 커밋 (수정 있을 경우): `chore: 프롬프트 다듬기` | 커밋 성공 |

### 7. 완료
**전제**: 6단계 완료

| 순서 | 담당 | 작업 | 검증 |
|------|------|------|------|
| 7-1 | 빌드 망고 | plan.md 삭제 | 파일 없음 |
| 7-2 | 빌드 망고 | package.json 버전 업데이트 | - |
| 7-3 | 빌드 망고 | 커밋: `chore: 버전 업데이트` | 커밋 성공 |
| 7-4 | 사용자 | PR 리뷰 | - |
| 7-5 | PR 망고 | PR 머지 (`gh pr merge --merge`) | 머지 성공 |
| 7-6 | 코치 망고 | GitHub Actions 확인 | 통과 |

## 검증 요약
- 빌드: 각 단계마다 `npm run build` 성공
- 로컬 테스트 (3, 5단계):
  - 망고 → Task로 plan-mango 호출 가능
  - plan-mango → call_mango로 issue-mango 호출 가능
  - issue-mango → call_mango 도구 없음 확인